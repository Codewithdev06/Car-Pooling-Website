<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer a Ride | Carpool Connect</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Offer-Specific: Loading Spinner */
        .loading {
            position: relative;
            color: transparent;
        }
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>üöó Carpool Connect</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="rides.html">Find a Ride</a>
            <a href="offer.html">Offer a Ride</a>
            <a href="contact.html">Contact</a>
            <a href="login.html">Login</a>
            <a href="signup.html">Sign Up</a>
        </nav>
    </header>

    <main>
        <section class="form-section">
            <h2>Offer a Ride</h2>
            <div id="message" class="message"></div>
            <form id="offerForm">
                <label for="from">From (Starting Location):</label>
                <input type="text" id="from" placeholder="e.g., Bhayandar" required>

                <label for="to">To (Destination):</label>
                <input type="text" id="to" placeholder="e.g., Govandi" required>

                <label for="date">Date:</label>
                <input type="date" id="date" required>

                <label for="time">Time:</label>
                <input type="time" id="time" required>

                <label for="seats">Available Seats:</label>
                <input type="number" id="seats" min="1" max="10" placeholder="e.g., 3" required>

                <label for="price">Price per Seat(‚Çπ):</label>
                <input type="number" id="price" min="0" step="0.01" placeholder="e.g., 200" required>

                <button type="submit" id="submitBtn">Offer Ride</button>
            </form>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Carpool Connect. Ride Together, Save Together.</p>
    </footer>

    <script>
        // Unified message function
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            messageEl.setAttribute('role', 'alert');
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 4000);
        }

        // Safe localStorage helpers
        function getRides() {
            try {
                const rides = localStorage.getItem('rides');
                return rides ? JSON.parse(rides) : [];
            } catch (e) {
                console.error('Error loading rides:', e);
                showMessage('‚ö†Ô∏è Error loading data. Starting fresh.', 'error');
                return [];
            }
        }

        function saveRides(rides) {
            try {
                localStorage.setItem('rides', JSON.stringify(rides));
            } catch (e) {
                console.error('Error saving rides:', e);
                showMessage('‚ùå Failed to save ride. Please try again.', 'error');
            }
        }

        // Generate unique ID
        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Get logged-in user (optional personalization)
        function getLoggedInUser() {
            try {
                return localStorage.getItem('loggedInUser') ? JSON.parse(localStorage.getItem('loggedInUser')) : null;
            } catch (e) {
                return null;
            }
        }

        // Real-time date validation (future date only)
        document.getElementById('date').addEventListener('input', function() {
            const today = new Date().toISOString().split('T')[0];
            if (this.value < today) {
                this.setCustomValidity('Date must be today or in the future.');
                showMessage('‚ö†Ô∏è Date must be today or future.', 'error');
            } else {
                this.setCustomValidity('');
            }
        });

        // Form submission with enhanced validation
        document.getElementById('offerForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const from = document.getElementById('from').value.trim();
            const to = document.getElementById('to').value.trim();
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const seats = parseInt(document.getElementById('seats').value);
            const price = parseFloat(document.getElementById('price').value);
            const submitBtn = document.getElementById('submitBtn');

            // Validation
            if (!from || !to || !date || !time || isNaN(seats) || isNaN(price)) {
                showMessage('‚ö†Ô∏è Please fill all fields correctly.', 'error');
                return;
            }
            if (from === to) {
                showMessage('‚ö†Ô∏è From and To locations must be different.', 'error');
                return;
            }
            if (seats < 1 || seats > 4) {
                showMessage('‚ö†Ô∏è Seats must be between 1 and 4.', 'error');
                return;
            }
            if (price < 0) {
                showMessage('‚ö†Ô∏è Price cannot be negative.', 'error');
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            if (date < today) {
                showMessage('‚ö†Ô∏è Date must be today or in the future.', 'error');
                return;
            }

            // Loading state
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            submitBtn.textContent = 'Offering Ride...';

            // Confirm
            if (!confirm(`Confirm offering ride from ${from} to ${to} on ${date} at ${time}?`)) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                submitBtn.textContent = 'Offer Ride';
                return;
            }

            // Create ride
            const newRide = {
                id: generateId(),
                from,
                to,
                date,
                time,
                seats,
                price,
                offeredBy: getLoggedInUser()?.name || 'Anonymous' // Personalize if logged in
            };

            // Save
            let rides = getRides();
            rides.push(newRide);
            saveRides(rides);

            const userName = getLoggedInUser()?.name || '';
            showMessage(`‚úÖ Ride offered successfully${userName ? ` by ${userName}` : ''}! Check available rides.`, 'success');

            // Reset form
            this.reset();
            submitBtn.disabled = false;
            submitBtn.classList.remove('loading');
            submitBtn.textContent = 'Offer Ride';

            // Auto-focus first field
            document.getElementById('from').focus();
        });

        // Initialize: Auto-focus and set min date
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            dateInput.value = today; // Default to today
            document.getElementById('from').focus();

            // Optional: Check login for offer
            if (!getLoggedInUser()) {
                showMessage('‚ÑπÔ∏è Log in to personalize your rides.', 'info');
            }
        });
    </script>
</body>
</html>